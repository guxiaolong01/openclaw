name: Sync OpenClaw Official Repository

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ²¡æœ‰æ›´æ–°ï¼‰'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºé•œåƒä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
    
    - name: é…ç½®Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
    
    - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
      run: |
        git remote add upstream https://github.com/openclaw/openclaw.git || true
        git fetch upstream
    
    - name: æ£€æŸ¥æ›´æ–°
      id: check
      run: |
        LOCAL_COMMIT=$(git rev-parse main)
        UPSTREAM_COMMIT=$(git rev-parse upstream/main)
        
        echo "æœ¬åœ°æäº¤: ${LOCAL_COMMIT:0:8}"
        echo "ä¸Šæ¸¸æäº¤: ${UPSTREAM_COMMIT:0:8}"
        
        if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ] && [ "${{ github.event.inputs.force }}" != "true" ]; then
          echo "status=no_update" >> $GITHUB_OUTPUT
          echo "âœ… å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬"
        else
          echo "status=needs_update" >> $GITHUB_OUTPUT
          echo "ğŸ“¥ å‘ç°æ›´æ–°æˆ–å¼ºåˆ¶åŒæ­¥"
        fi
    
    - name: åŒæ­¥æ›´æ–°
      if: steps.check.outputs.status == 'needs_update'
      run: |
        echo "ğŸ”„ å¼€å§‹åŒæ­¥..."
        
        # å°è¯•åˆå¹¶
        if git merge --no-edit upstream/main; then
          echo "âœ… åˆå¹¶æˆåŠŸ"
          
          # æ¨é€åˆ°é•œåƒä»“åº“
          git push origin main
          echo "ğŸš€ æ¨é€æˆåŠŸ"
          
          # åˆ›å»ºæˆåŠŸçŠ¶æ€
          echo "SYNC_RESULT=success" >> $GITHUB_ENV
          echo "SYNC_MESSAGE=åŒæ­¥æˆåŠŸï¼å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_ENV
        else
          echo "âŒ åˆå¹¶å†²çª"
          
          # å°è¯•é‡ç½®å¹¶å¼ºåˆ¶æ¨é€ï¼ˆå¯¹äºé•œåƒä»“åº“é€šå¸¸å¯ä»¥ï¼‰
          echo "ğŸ”„ å°è¯•å¼ºåˆ¶åŒæ­¥..."
          git reset --hard upstream/main
          git push --force origin main
          
          echo "SYNC_RESULT=force_sync" >> $GITHUB_ENV
          echo "SYNC_MESSAGE=åŒæ­¥å®Œæˆï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰ã€‚" >> $GITHUB_ENV
        fi
    
    - name: å‘é€é€šçŸ¥
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { repo, owner } = context.repo;
          const runId = context.runId;
          const workflow = context.workflow;
          
          let message = '';
          let color = 'gray';
          
          if (process.env.SYNC_RESULT === 'success') {
            message = `âœ… ${process.env.SYNC_MESSAGE}`;
            color = 'green';
          } else if (process.env.SYNC_RESULT === 'force_sync') {
            message = `âš ï¸ ${process.env.SYNC_MESSAGE}`;
            color = 'yellow';
          } else if (steps.check.outputs.status === 'no_update') {
            message = 'â„¹ï¸ å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥';
            color = 'blue';
          } else {
            message = 'âŒ åŒæ­¥å¤±è´¥';
            color = 'red';
          }
          
          // åˆ›å»ºIssueè¯„è®ºæˆ–ä½¿ç”¨å…¶ä»–é€šçŸ¥æ–¹å¼
          console.log(`åŒæ­¥ç»“æœ: ${message}`);
          
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é£ä¹¦ã€Slackç­‰é€šçŸ¥é›†æˆ
